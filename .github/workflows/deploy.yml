name: Deploy Ayo Backend

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'è¦éƒ¨ç½²çš„åˆ†æ”¯'
        required: true
        default: 'main'
        type: choice
        options:
          - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
            
            # åŠ è½½ç¯å¢ƒå˜é‡é…ç½®
            if [ -f ~/.bashrc ]; then
              source ~/.bashrc
            fi
            if [ -f ~/.zshrc ]; then
              source ~/.zshrc
            fi
            
            # æ·»åŠ å®å¡”Node.jså’Œpnpmåˆ°PATH
            export PATH="/www/server/nodejs/v24.12.0/bin:$PATH"
            
            # éªŒè¯pnpmæ˜¯å¦å¯ç”¨
            if ! command -v pnpm &> /dev/null; then
              echo "âŒ pnpm å‘½ä»¤æœªæ‰¾åˆ°"
              exit 1
            fi
            echo "âœ… pnpm ä½ç½®: $(command -v pnpm)"
            
            PROJECT_PATH="${{ secrets.PROJECT_PATH }}"
            cd "$PROJECT_PATH"
            
            echo "ğŸ“¦ å¼€å§‹éƒ¨ç½²..."
            echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"
            echo "ğŸ” å½“å‰åˆ†æ”¯: $(git branch --show-current)"
            echo "ğŸ“ æœ€æ–°æäº¤: $(git log -1 --oneline)"
            
            # å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆç”¨äºå›æ»šï¼‰
            echo "ğŸ’¾ å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
            CURRENT_COMMIT=$(git rev-parse HEAD)
            echo "å½“å‰æäº¤: $CURRENT_COMMIT"
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            DEPLOY_BRANCH="${{ github.event.inputs.branch }}"
            echo "â¬‡ï¸  æ‹‰å–æœ€æ–°ä»£ç  (åˆ†æ”¯: $DEPLOY_BRANCH)..."
            git fetch origin $DEPLOY_BRANCH
            git checkout $DEPLOY_BRANCH || {
              echo "âŒ åˆ‡æ¢åˆ†æ”¯å¤±è´¥"
              exit 1
            }
            git pull origin $DEPLOY_BRANCH || {
              echo "âŒ Git pull å¤±è´¥"
              exit 1
            }
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æäº¤
            NEW_COMMIT=$(git rev-parse HEAD)
            if [ "$CURRENT_COMMIT" = "$NEW_COMMIT" ]; then
              echo "â„¹ï¸  æ²¡æœ‰æ–°æäº¤ï¼Œè·³è¿‡éƒ¨ç½²"
              exit 0
            fi
            
            echo "âœ… ä»£ç å·²æ›´æ–°: $CURRENT_COMMIT -> $NEW_COMMIT"
            
            # å®‰è£…ä¾èµ–
            echo "ğŸ“¥ å®‰è£…ä¾èµ–..."
            pnpm install --frozen-lockfile || {
              echo "âŒ pnpm install å¤±è´¥"
              exit 1
            }
            
            # è¿è¡Œæ•°æ®åº“è¿ç§»
            echo "ğŸ—„ï¸  è¿è¡Œæ•°æ®åº“è¿ç§»..."
            node ace migration:run || {
              echo "âš ï¸  æ•°æ®åº“è¿ç§»å¤±è´¥ï¼Œä½†ç»§ç»­éƒ¨ç½²æµç¨‹"
            }
            
            # æ„å»ºé¡¹ç›®
            echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
            pnpm run build || {
              echo "âŒ æ„å»ºå¤±è´¥"
              exit 1
            }
            
            # æ£€æŸ¥æ„å»ºç»“æœ
            if [ ! -d "build" ]; then
              echo "âŒ build ç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¯èƒ½å¤±è´¥"
              exit 1
            fi
            
            echo "âœ… æ„å»ºæˆåŠŸ"
            
            # å®‰è£…ç”Ÿäº§ç¯å¢ƒä¾èµ–åˆ° build ç›®å½•
            echo "ğŸ“¥ å®‰è£…ç”Ÿäº§ç¯å¢ƒä¾èµ–åˆ° build ç›®å½•..."
            cd build
            pnpm install --prod || {
              echo "âŒ build ç›®å½•ä¾èµ–å®‰è£…å¤±è´¥"
              exit 1
            }
            cd ..
            echo "âœ… ç”Ÿäº§ä¾èµ–å®‰è£…å®Œæˆ"
            
            # é‡å¯åº”ç”¨
            echo "ğŸ”„ é‡å¯åº”ç”¨..."
            pm2 restart all || {
              echo "âŒ PM2 é‡å¯å¤±è´¥"
              exit 1
            }
            
            # æ£€æŸ¥åº”ç”¨çŠ¶æ€
            echo "ğŸ” æ£€æŸ¥åº”ç”¨çŠ¶æ€..."
            sleep 3
            pm2 status
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "ğŸ“ éƒ¨ç½²ç‰ˆæœ¬: $NEW_COMMIT"
            echo "ğŸ• éƒ¨ç½²æ—¶é—´: $(date)"
          EOF
